# Cloudinary 配置指南

## 概述
Cloudinary 是一个强大的云服务，提供视频压缩、优化和存储功能。我们将使用它来解决 Coze API 的 52MB 视频大小限制问题。

## 优势
- ✅ **自动压缩**: 智能压缩算法，保持视频质量
- ✅ **云端处理**: 无需本地 ffmpeg 安装
- ✅ **多种格式**: 支持各种视频格式转换
- ✅ **CDN加速**: 全球内容分发网络
- ✅ **免费额度**: 每月有免费使用额度

## 配置步骤

### 1. 注册 Cloudinary 账户
1. 访问 [Cloudinary 官网](https://cloudinary.com/)
2. 点击 "Sign Up For Free"
3. 填写基本信息并验证邮箱

### 2. 获取配置信息
登录后，在 Dashboard 页面可以看到：
- **Cloud Name**: 你的云名称
- **API Key**: API 密钥
- **API Secret**: API 密钥密码

### 3. 环境变量配置
在项目根目录创建或编辑 `.env.local` 文件：

```bash
# Cloudinary 配置
CLOUDINARY_CLOUD_NAME=your_cloud_name
CLOUDINARY_API_KEY=your_api_key
CLOUDINARY_API_SECRET=your_api_secret

# 其他配置保持不变
COZE_ACCESS_TOKEN=your_coze_token
COZE_BOT_ID=your_bot_id
# ... 其他配置
```

### 4. 验证配置
重启开发服务器后，访问 `/api/config/status` 检查配置状态。

## 工作原理

### 压缩流程
1. **文件上传**: 视频文件上传到 Cloudinary
2. **智能压缩**: 使用优化的压缩算法
3. **格式转换**: 转换为 MP4 格式，H.264 编码
4. **质量优化**: 自动调整比特率和分辨率
5. **URL生成**: 生成压缩后的视频URL

### 压缩参数
- **目标大小**: 50MB 以下
- **视频编码**: H.264
- **音频编码**: AAC
- **分辨率**: 最大 1280x720
- **帧率**: 25fps
- **比特率**: 500kbps

## 使用场景

### 自动压缩
- 文件超过 52MB 时自动触发
- 压缩后直接使用压缩版本
- 保持原始文件作为备份

### 手动控制
- 可选择是否启用压缩
- 可调整压缩参数
- 可查看压缩前后对比

## 成本说明

### 免费计划
- **存储**: 25GB
- **带宽**: 25GB/月
- **转换**: 25GB/月
- **API调用**: 25,000次/月

### 付费计划
- **Advanced**: $89/月起
- **Custom**: 联系销售

## 故障排除

### 常见问题

#### 1. 配置错误
```
Error: Cloudinary配置不完整
```
**解决方案**: 检查环境变量是否正确设置

#### 2. 上传失败
```
Error: Cloudinary上传失败
```
**解决方案**: 
- 检查网络连接
- 验证API密钥
- 检查文件大小限制

#### 3. 压缩失败
```
Error: 视频压缩失败
```
**解决方案**:
- 检查视频格式是否支持
- 验证文件完整性
- 查看Cloudinary日志

### 调试方法
1. **查看控制台日志**: 详细的错误信息
2. **检查网络请求**: 查看API调用状态
3. **验证配置**: 使用 `/api/config/status` 接口

## 最佳实践

### 1. 文件管理
- 定期清理不需要的文件
- 使用有意义的文件夹结构
- 监控存储使用量

### 2. 压缩策略
- 根据内容类型调整压缩参数
- 平衡文件大小和质量
- 考虑用户网络环境

### 3. 错误处理
- 实现优雅的降级机制
- 提供用户友好的错误信息
- 记录详细的错误日志

## 安全考虑

### 1. API密钥保护
- 不要在代码中硬编码
- 使用环境变量
- 定期轮换密钥

### 2. 访问控制
- 限制上传文件类型
- 设置文件大小上限
- 监控异常使用

### 3. 数据隐私
- 了解数据存储位置
- 遵守相关法规
- 定期审查权限设置

## 总结

Cloudinary 提供了一个优雅的解决方案来处理视频大小限制问题：

1. **自动化**: 无需手动压缩
2. **高质量**: 智能算法保持质量
3. **可靠性**: 云端服务，稳定可靠
4. **成本效益**: 免费额度足够测试使用

通过集成 Cloudinary，你的应用现在可以：
- 自动处理大文件
- 提供更好的用户体验
- 减少存储和带宽成本
- 确保 Coze API 兼容性

配置完成后，系统将自动为超过 52MB 的视频文件提供压缩服务，确保它们能够被 Coze API 成功分析。
